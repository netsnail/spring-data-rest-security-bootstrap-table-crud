<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
		<title>产品列表</title>
		<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
		<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
		<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/locale/bootstrap-table-zh-CN.min.js"></script>
		<script src="//code.highcharts.com/maps/highmaps.js"></script>
		<script src="//img.hcharts.cn/mapdata/cn-with-citys.js"></script>
		<style type="text/css">.search,.toolbar { margin:5px 0; }</style>
	</head>
	<body>
		<div class="container">
			<nav class="navbar navbar-default" role="navigation">
			    <div class="container-fluid">
			    <div class="navbar-header">
			        <button type="button" class="navbar-toggle" data-toggle="collapse"
			                data-target="#example-navbar-collapse">
			            <span class="sr-only">Swith</span>
			            <span class="icon-bar"></span>
			            <span class="icon-bar"></span>
			            <span class="icon-bar"></span>
			        </button>
			        <a class="navbar-brand" href="#">Home</a>
			    </div>
			    <div class="collapse navbar-collapse" id="example-navbar-collapse">
			        <ul class="nav navbar-nav">
			            <li><a href="#">One</a></li>
			            <li class="dropdown">
			                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
			                    Two <b class="caret"></b>
			                </a>
			                <ul class="dropdown-menu">
			                    <li><a href="#">Test</a></li>
			                    <li><a href="#">Test</a></li>
			                    <li class="divider"></li>
			                    <li><a href="#">Link</a></li>
			                </ul>
			            </li>
			        </ul>
			        <ul class="nav navbar-nav navbar-right">
			            <li><a href="/items/login" target="_none">Login</a>
			            <iframe name="_none" style="height:0;width:0;display:none;"></iframe>
			            </li>
			        </ul>
			    </div>
			    </div>
			</nav>
			<h1 class="text-center">产品列表</h1>
			<div class="row">
            <div id="view1" class="col-md-6" style="height: 500px;"></div>
            <div id="view2" class="col-md-6" style="height: 500px;"></div>
        </div>
			<div class="search">
				<form id="search-form" class="form-inline">
				  <div class="form-group">
				    <label for="keyword">关键词</label>
				    <input type="text" class="form-control" name="keyword" placeholder="产品或公司名称">
				  </div>
				  <button type="button" class="btn btn-default" id="search-button">Search</button>
				</form>
			</div>
			<div class="toolbar text-right">
				<button type="button" class="btn btn-primary" id="add-button">Create</button>
			</div>
			<div id="table-msg" class="bg-danger"></div>
			<table id="table"
				data-search="false"
				data-search-on-enter-key="true"
				data-custom-search="false"
				data-show-refresh="false"
				data-show-toggle="false"
				data-show-columns="false"
				data-show-export="false"
				data-detail-view="false"
				data-minimum-count-columns="2"
				data-show-pagination-switch="false"
				data-page-size="10"
				data-page-list="[10, 25, 50, 100, ALL]"
				data-show-footer="false"
              data-height="460"
              data-pagination="true"
              data-side-pagination="server"
              data-query-params="query_params"
				data-response-handler="response_handler"
              	>
              <thead>
                <tr>
                    <th data-field="productName">产品名称</th>
                    <th data-field="opType">类别</th>
                    <th data-field="province">地区</th>
                    <th data-field="category">品类</th>
                    <th data-field="company">申报单位</th>
                    <th data-field="approveDate">获批日期</th>
                    <th data-field="zongjuNo">质检总局公告</th>
                    <th data-formatter="detail_formatter">操作</th>
                </tr>
				</thead>
			</table>
			<!-- Modal -->
			<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			        <h4 class="modal-title" id="myModalLabel">产品信息</h4>
			      </div>
			      <form id="edit-form">
			      <div class="modal-body">
			      	<p id="msg" class="bg-info"></p>
					  <div class="form-group">
					    <label for="productName">产品名称</label>
					    <input type="text" class="form-control" id="productName" name="productName" placeholder="产品名称">
					  </div>
					  <div class="form-group">
					    <label for="opType">类别</label>
					    <select class="form-control" id="opType" name="opType">
                           <option>初评</option>
                            <option>复评</option>
                        </select>
					  </div>
					  <div class="form-group">
					    <label for="province">地区</label>
					    <select class="form-control" id="province" name="province">
					       <option>上海</option>
							<option>云南</option>
							<option>内蒙古</option>
							<option>北京</option>
							<option>吉林</option>
							<option>四川</option>
							<option>天津</option>
							<option>宁夏</option>
							<option>宁波</option>
							<option>安徽</option>
							<option>山东</option>
							<option>山西</option>
							<option>广东</option>
							<option>广西</option>
							<option>新疆</option>
							<option>江苏</option>
							<option>江西</option>
							<option>河北</option>
							<option>河南</option>
							<option>浙江</option>
							<option>深圳</option>
							<option>湖北</option>
							<option>湖南</option>
							<option>甘肃</option>
							<option>福建</option>
							<option>西藏</option>
							<option>贵州</option>
							<option>辽宁</option>
							<option>重庆</option>
							<option>陕西</option>
							<option>青海</option>
							<option>黑龙江</option>
							<option>海南</option>
							<option>台湾</option>
					    </select>
					  </div>
					  <div class="form-group">
					    <label for="category">品类</label>
					    <select class="form-control" id="category" name="category">
						    <option>中药材</option>
							<option>乳制品</option>
							<option>保健品</option>
							<option>农副产品</option>
							<option>工业品</option>
							<option>文化产品</option>
							<option>植物</option>
							<option>水产品及制品</option>
							<option>禽畜肉及制品</option>
							<option>竹木制品</option>
							<option>粮食</option>
							<option>纺织品</option>
							<option>茶叶</option>
							<option>蔬菜水果</option>
							<option>酒类</option>
							<option>食用菌</option>
							<option>饮料</option>
							<option>饲料</option>
					    </select>
					  </div>
					  <div class="form-group">
					    <label for="company">申报单位</label>
					    <input type="text" class="form-control" id="company" name="company" placeholder="申报单位">
					  </div>
					  <div class="form-group">
					    <label for="approveDate">获批日期</label>
					    <input type="date" class="form-control" id="approveDate" name="approveDate" placeholder="获批日期">
					  </div>
					  <div class="form-group">
					    <label for="zongjuNo">质检总局公告</label>
					    <input type="text" class="form-control" id="zongjuNo" name="zongjuNo" placeholder="质检总局公告">
					  </div>
			      </div>
			      <div class="modal-footer">
			        <button type="reset" class="btn">重置</button>
			        <button type="button" class="btn btn-primary" id="form-submit">提交</button>
			        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
			      </div>
			      </form>
			    </div>
			  </div>
			</div>
		</div>
		
		<script type="text/javascript">
			var main_url="/items";
			var search_url="/items/search/findByProductNameContainingOrCompanyContaining";
			var search_province="/items/search/findByProvince";
			var search_category="/items/search/findByCategory";
			
			var _bootstrapTable=$('#table').bootstrapTable({ url: main_url });
			
			function response_handler (res) {
				return { rows: (res._embedded ? res._embedded.items : []), total: res.page.totalElements };
			}
			function fill_form(data) {
				var _form=$('#edit-form');
				$('#productName', _form).val(data.productName);
				$('#opType', _form).val(data.opType);
				$('#category', _form).val(data.category);
				$('#province', _form).val(data.province);
				$('#company', _form).val(data.company);
				$('#approveDate', _form).val(data.approveDate);
				$('#zongjuNo', _form).val(data.zongjuNo);
			}
			function query_params (params) {
				return { page: params.offset/params.limit, size: params.limit, sort: 'id,desc' };
			}
			$('#search-button').click(function () {
				var params=$('#search-form').serialize();
				_bootstrapTable.data('bootstrap.table').options.url=search_url+'?'+params;
				_bootstrapTable.bootstrapTable('refresh');
			})
			function detail_formatter (index, row) {
				return "<button class=\"btn btn-primary\" onclick=\"_edit('"+row._links.self.href+"')\">Edit</button> "
				+"<button class=\"btn btn-default\" onclick=\"_delete('"+row._links.self.href+"')\">Delete</button>"
			}
			// save
			$('#add-button').click(function() {
				$('#edit-form')[0].reset();
				$('#myModal').modal(true)
				$('#form-submit').unbind('click').bind('click', function() {
					var json=$('#edit-form').serializeArray();
					var _data = {};
			        for (var item in json) {
			        	_data[json[item].name] = json[item].value;
			        }
					$.ajax({
					  type: 'POST',
					  url: main_url,
					  contentType: 'application/json',
					  data: JSON.stringify(_data),
					  dataType: 'json',
					  success: function(data, textStatus, xhr) {
					        if (xhr.status==201) data=xhr.getResponseHeader("location");
					        _success("新增成功");
					    },
					    error: function(xhr, textStatus, ex) {
					        if (xhr.status==201) { _success("新增成功"); return; }
					        if (xhr.status==401) { 
					        	$("#msg").removeClass().addClass('bg-danger').text('Unauthorized');
					        	return; 
					         }
					        $("#msg").removeClass().addClass('bg-danger').text(textStatus + "," + ex + "," + xhr.responseText);
					    }
					})
				});
			})
			function _edit (url) {
				$.getJSON(url, function (data) {
					fill_form(data);
					$('#myModal').modal(true)
					$('#form-submit').unbind('click').bind('click', function() {
						var json=$('#edit-form').serializeArray();
						var _data = {};
				        for (var item in json) {
				        	_data[json[item].name] = json[item].value;
				        }
						$.ajax({
						  type: 'PUT',
						  url: url,
						  contentType: 'application/json',
						  data: JSON.stringify(_data),
						  dataType: 'json',
						  success: function(data, textStatus, xhr) {
						        if (xhr.status==201) data=xhr.getResponseHeader("location");
						        _success("更新成功");
						    },
						    error: function(xhr, textStatus, ex) {
						        if (xhr.status==201) { _success("更新成功"); return; }
						        if (xhr.status==401) { 
						        	$("#msg").removeClass().addClass('bg-danger').text('Unauthorized');
						        	return; 
						         }
						        $("#msg").removeClass().addClass('bg-danger').text(textStatus + "," + ex + "," + xhr.responseText);
						    }
						})
					})
				});
			}
			function _delete (url) {
				$.ajax({
					  type: 'DELETE',
					  url: url,
					  dataType: 'json',
					  success: function(data, textStatus, xhr) {
					        if (xhr.status==204) data=xhr.getResponseHeader("location");
					        _success("删除成功"); 
					    },
					    error: function(xhr, textStatus, ex) {
					        if (xhr.status==204) { return; }
					        if (xhr.status==401) { 
					        	$('#table-msg').removeClass().addClass('bg-danger').text('Unauthorized')
					        	return; 
					         }
					        $('#table-msg').removeClass().addClass('bg-danger').text('Delete failed')
					    }
					})
			}
			function _success(msg) {
				$('#myModal').modal('hide');
				$('#edit-form')[0].reset();
				$("#table").bootstrapTable('refresh');
				$('#table-msg').show().html(" "+msg).delay(3000).fadeOut();
			}
		</script>
		<script type="text/javascript">
        $(function() {
             $.getJSON('/items/groupby/province', function (data) {
                    var _data=[];
                    for (var item in data) {
                        var key=data[item][0],val=data[item][1];
                        _data.push({name:key,value:val})
                    }
                    var mapArray = Highcharts.maps['cn-with-city'];
                    $('#view1').highcharts('Map',{ title : { text : '' },
                                        plotOptions : { series : { showInLegend : false } },
                                        series : [ { name : '数量', data : _data, mapData : mapArray, joinBy : [ 'name' ], dataLabels: { enabled: true, format: '{point.value}' },
                                                    events : {
                                                        click : function(e) {
                                                            _bootstrapTable.data('bootstrap.table').options.url=search_province+'?province='+e.point.name;
                                                            _bootstrapTable.bootstrapTable('refresh');
                                                        }
                                                    }, }, ] }, function(map) { });
                })
            
          $.getJSON('/items/groupby/category', function (data) {
                var keys=[],values=[]
                for (var item in data) {
                    var key=data[item][0],val=data[item][1];
                    keys.push(key);values.push(val);
                }
                $('#view2').highcharts( { title : '', chart : { type : 'column', },
                            plotOptions : { series : { showInLegend : false } },
                            xAxis : { categories : keys, crosshair : true },
                            yAxis : { min : 0, title : { text : '数量' } },
                            series : [ { type : 'column', name : '数量', data : values,
                                        events : {
                                            click : function(e) {
                                                _bootstrapTable.data('bootstrap.table').options.url=search_category+'?category='+e.point.category;
                                                _bootstrapTable.bootstrapTable('refresh');
                                            },
                                        }, }, ] });
         });

            });
        </script>
	</body>
</html>
